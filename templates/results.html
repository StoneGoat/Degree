<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scan Results for {{ domain }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Scan Results</h1>
      <div class="header-buttons">
        <a href="{{ url_for('download_pdf', scan_id=scan_id) }}"
           class="download-button"
           title="Download full report as PDF">
          <i class="fa fa-file-pdf"></i>
        </a>
        <a href="{{ url_for('index') }}" class="back-button">New Scan</a>
      </div>
    </div>

    <div class="scan-info">
      <p><strong>Domain:</strong> {{ domain }}</p>
      <p><strong>Scan ID:</strong> {{ scan_id }}</p>
    </div>

    <div id="loading-indicator">
      <div class="spinner"></div>
      <p id="loading-text">Scanning in progress...</p>
    </div>

    <div id="results-container">
      <p>Initializing scan... Results will appear here automatically.</p>
    </div>
  </div>

  <script>
    $(document).ready(function(){
      const scanId = "{{ scan_id }}";
      let scanComplete = false;

      function loadResults() {
        $.get("{{ url_for('get_markdown') }}", { scan_id: scanId })
         .done(function(response) {
            if (response.markdown) {
              $("#results-container").html(marked.parse(response.markdown));
              if (response.markdown.includes("## Scan Complete") ||
                  response.markdown.includes("## Error During Scan")) {
                scanComplete = true;
                clearInterval(poll);
                $("#loading-indicator").hide();
              }
            }
         })
         .fail(function() {
           $("#results-container").html("<p>Failed to load results.</p>");
         });
      }

      // initial load + polling
      loadResults();
      const poll = setInterval(loadResults, 3000);

      // animate dots
      let dots = 0;
      setInterval(function() {
        if (!scanComplete) {
          dots = (dots + 1) % 4;
          $("#loading-text").text("Scanning in progress" + ".".repeat(dots));
        }
      }, 500);
    });
  </script>
</body>
</html>
